# Generated using Android NDK LTS Version (r27d, clang 18.0.4).
# The API level 21 is Android 5 Lollipop.
# The GNU GMP library is Termux libgmp-static package (gmp.h, libgmp.a); OpenCL is Termux ocl-icd package (libOpenCL.a).
# Tested under Termux 0.118.3.
# Thanks to Pavel Rosick√Ω https://github.com/ahorek for his support.
CC = aarch64-linux-android35-clang++ -std=c++17
RM = rm

ROOT_DIR = ..

BIN_DIR = $(ROOT_DIR)/bin
SRC_DIR = $(ROOT_DIR)/src

GMP_DIR = $(ROOT_DIR)/gmp
GMP_INC = -I$(GMP_DIR)
GMP_LIB = -L$(GMP_DIR)/lib -lgmp -ldl

OCL_DIR = $(ROOT_DIR)/Khronos
OCL_INC = -I$(OCL_DIR)
OCL_LIB = -L$(OCL_DIR)/lib -lOpenCL

CFLAGS = -Wall -Wextra -Wsign-conversion -ffinite-math-only $(GMP_INC)
FLAGS_CPU = -O3 -fopenmp
FLAGS_GPU = -O3 -DGPU

OBJS_CPU = main.o transform_neon.o
OBJS_GPU = maing.o transform_ocl.o
DEPS_COMMON = $(SRC_DIR)/transform.h $(SRC_DIR)/file.h $(SRC_DIR)/gint.h $(SRC_DIR)/pio.h $(SRC_DIR)/boinc.h
DEPS_MAIN = $(SRC_DIR)/genefer.h $(SRC_DIR)/timer.h $(DEPS_COMMON)
DEPS_TRANSFORM_CPUf64 = $(SRC_DIR)/transformCPUf64.h $(SRC_DIR)/transformCPUf64s.h $(SRC_DIR)/f64vector.h $(SRC_DIR)/simd128d.h $(DEPS_COMMON)
DEPS_TRANSFORM_GPU = $(SRC_DIR)/transformGPU.h $(SRC_DIR)/ocl.h $(DEPS_COMMON)

EXEC_CPU = $(BIN_DIR)/genefer_androidARM64
EXEC_GPU = $(BIN_DIR)/geneferg_androidARM64

.PHONY: all clean_obj rebuild

all: $(EXEC_CPU) $(EXEC_GPU)

clean_obj:
	$(RM) $(OBJS_CPU) $(OBJS_GPU)

rebuild: clean_obj all

main.o: $(SRC_DIR)/main.cpp $(DEPS_MAIN)
	$(CC) $(CFLAGS) $(FLAGS_CPU) -c $< -o $@

maing.o: $(SRC_DIR)/main.cpp $(DEPS_MAIN)
	$(CC) $(CFLAGS) $(FLAGS_GPU) $(OCL_INC) -c $< -o $@

transform_neon.o: $(SRC_DIR)/transform_neon.cpp $(DEPS_TRANSFORM_CPUf64)
	$(CC) $(CFLAGS) $(FLAGS_CPU) -c $< -o $@
	$(CC) $(CFLAGS) $(FLAGS_CPU) -c -S $< -o neon.asm

transform_ocl.o: $(SRC_DIR)/transform_ocl.cpp $(DEPS_TRANSFORM_GPU)
	$(CC) $(CFLAGS) $(FLAGS_GPU) $(OCL_INC) -c $< -o $@

$(EXEC_CPU): $(OBJS_CPU)
	$(CC) $(FLAGS_CPU) -static $^ $(GMP_LIB) -o $@

$(EXEC_GPU): $(OBJS_GPU)
	$(CC) $(FLAGS_GPU) -static $^ $(GMP_LIB) $(OCL_LIB) -o $@
